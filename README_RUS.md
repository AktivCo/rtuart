[Английский/English](README.md)

## Описание

Rtuart -- это реализация драйвера пользовательского уровня ([IFD Handler](https://pcsclite.apdu.fr/api/group__IFDHandler.html#details)), предназначенного для обеспечения возможности взаимодействия с [Рутокен 4010](https://www.rutoken.ru/products/all/rutoken-m2m/#models), подключенного к последовательному порту, через PCSC интерфейс с использованием [pcsc-lite](https://pcsclite.apdu.fr/).

Артефакты проекта:
* `librtuart.so` -- библиотека драйвера. По умолчанию устанавливается в `/usr/lib/pcsc/drivers/serial/`.
* `librtuart` -- файл конфигурации драйвера, используемый pcscd для загрузки драйвера. По умолчанию устанавливается в `/etc/reader.conf.d/`.
* `rtuart_transport_test` -- приложение, тестирующее низкоуровневый протокол взаимодействия с Рутокен 4010. По умолчанию устанавливается в `/usr/bin/`.

## How to build

Типичная последовательность действий для сборки и установки:

```
mkdir build || exit -1
cd build || exit -1
cmake .. || exit -1
make || exit -1
make install || exit -1
```

#### Переменные конфигурации сборки проекта CMake

* Чтобы указать путь до файла устройства последовательного порта, можно использовать переменную конфигурации CMake RTUART_SERIAL_PORT, например, `cmake -DRTUART_SERIAL_PORT=/serial/port/device/path ..`. По умолчанию установлен файл устройства `/dev/ttyS0`.

## Конфигурационный файл librtuart

Конфигурационный файл `librtuart` содержит следующие значения:
* `DEVICENAME` -- путь к файлу устройства последовательного порта, к которому подключен Рутокен 4010.
* `FRIENDLYNAME` -- базовое имя считывателя, используемое для идентификации смарткарт, работающих через данный драйвер, в API PCSC.
* `LIBPATH` -- путь к библиотеке драйвера `librtuart.so`.

Больше информации о конфигурационном файле можно найти в [документации pcsc-lite](https://pcsclite.apdu.fr/api/group__IFDHandler.html#details).

## rtuart_transport_test

`rtuart_transport_test` выполняет взаимодействие с Рутокен 4010 по низкоуровневому протоколу. Для запуска теста необходимо первым параметром указать путь к файлу устройства последовательного порта, например, так: `rtuart_transport_test /dev/ttyS0`. Приложение открывает файл устройства для взаимодействия Рутокен 4010, поэтому может потребоваться запуск с повышенными привилегиями. Кроме того, поскольку файл устройства последовательного порта открывается в эксклюзивном режиме, тест не может выполняться, пока загружен драйвер.

## Отладочный вывод

Драйвер выполняет вывод отладочной информации с использованием встроенного в pcscd механизма логирования. Куда будет писаться лог, зависит от режима запуска и настроек pcscd; в случае, если pcscd запущен в foreground-режиме, отладочный вывод перенаправляется в stdout.

Подробность отладочного вывода может регулироваться посредством установки значения переменной окружения `LIBRTUART_ifdLogLevel`. Значение этой переменной вычисляется как сумма значений, соответствующих выбранным дискретным уровням логирования:
* 1 -- логировать сообщения о критических ошибках;
* 2 -- логировать сообщения об ошибках;
* 4 -- логировать информационные сообщения;
* 8 -- логировать отладочные сообщения (включая периодические -- возникающие постоянно, с определенным интервалом).

Поддерживаются как десятичные, так и шестнадцатиричные значения переменной `LIBRTUART_ifdLogLevel`.

По умолчанию уровень отладочного вывода равен `3`, что значит логируются критический сообщения и сообщения об ошибках.

Запустить `pcscd` foreground-режиме с уровнем логирования, обеспечивающим вывод информации критических ошибках, просто ошибках и информационных сообщений, можно следующим образом: `sudo LIBRTUART_ifdLogLevel=7 pcscd -afd`.

## Лицензия

Проект распространяется по [двухпунктной лицензии BSD](LICENSE_RUS).

Публичные заголовочные файлы pcsc-lite в директории [PCSC](PCSC/include/PCSC) распространяются по оригинальной трехпунктной лицензии BSD; текст лицензии и указания авторства размещены в самих заголовочных файлах.